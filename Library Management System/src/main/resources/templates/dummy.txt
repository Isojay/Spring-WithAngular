var app = angular.module('student', ['ngTable']);


app.controller('LibraryController', function ($scope, $http,NgTableParams, $window, $timeout) {
	$scope.showLibrary = false;
	$scope.currentPage = 0;
	$scope.pageSize = 10000;
	$scope.keywordSemester = '';
	$scope.keywordName = '';
	$scope.keywordEmail = '';
	$scope.count = 0;

	function fetchStudents() {
		let apiUrl = '/api/';

		if ($scope.count !== 0) {
			apiUrl += `search?pagesize=${$scope.pageSize}&offset=${$scope.currentPage}`;

			if ($scope.keywordEmail) {
				apiUrl += `&email=${$scope.keywordEmail}`;
			}

			if ($scope.keywordName) {
				apiUrl += `&fName=${$scope.keywordName}`;
			}

			if ($scope.keywordSemester) {
				apiUrl += `&semester=${$scope.keywordSemester}`;
			}
		} else {
			apiUrl += `${$scope.pageSize}/${$scope.currentPage}`;
		}

		$http.get(apiUrl)
			.then(function (response) {
				$scope.students = response.data.content;
				const data = response.data.content;
				console.log("I was Here!!")
				console.log($scope.keywordEmail)
				$scope.tableParams = new NgTableParams(
					{
						page: 1, // Show the first page
						count: 10, // Number of items per page
						sorting: {
							fName: 'asc' // Default sorting by 'First Name' column in ascending order
						}
					},
					{
						dataset: data // Set the fetched data as the dataset
					}
				);
			})
			.catch(function (error) {
				console.error('Error fetching paginated students:', error);
			});
	}

	function fetchBook() {
		let apiUrl1 = '/api/getBook';
		$http.get(apiUrl1)
			.then(function (response) {
				$scope.books = response.data;
				const data1 = response.data;
				console.log("I was also Here!!")
				$scope.tableParams1 = new NgTableParams(
					{
						page: 1, // Show the first page
						count: 10, // Number of items per page
						sorting: {
							bcode: 'asc' // Default sorting by 'First Name' column in ascending order
						}
					},
					{
						dataset: data1 // Set the fetched data as the dataset
					}
				);
			})
			.catch(function (error) {
				console.error('Error fetching paginated students:', error);
			});
	}

	$scope.triggerHome = function () {
		$scope.showTable = null;
		$scope.showLibrary = false;
		fetchStudents();
	}

	$scope.triggerStudent = function () {
		$scope.showTable = true;
		$scope.showLibrary = true;
		fetchStudents();
	}
	$scope.triggerBook = function () {
		$scope.showLibrary = true;
		$scope.showTable = false;
		fetchBook();
	}

	$scope.Reset = function () {
		console.log("Reset")
		$scope.keywordSemester = null;
		$scope.keywordName = null;
		$scope.keywordEmail = null;
		$scope.count = 0;
		$scope.triggerStudent();
	};

	$scope.searchKeywords = function () {
		console.log("Keywords")
		$scope.count = 1;
		$scope.triggerStudent();
	}

	$scope.deleteStudent = function (studentID) {
		if (confirm('Are you sure you want to delete this task?')) {
			$http.delete('/api/delete/' + studentID)
				.then(function (response) {
					deleteMessage(true)
				})
				.catch(function (error) {
					console.error('Error deleting Student Data:', error);
				});
		}
	};

	$scope.deleteBook = function (BookID) {
		if (confirm('Are you sure you want to delete this task?')) {
			console.log(BookID)
			$http.delete('/api/deleteBook/' + BookID)
				.then(function () {
					deleteMessage(false);
				})
				.catch(function (error) {
					console.error('Error deleting Book:', error);
				});
		}
	};

	$scope.showDetails= function (stdId){
		$http.get('/api/getDetails/'+ stdId)
			.then(function (response){
				console.log("I am in Details")
				$scope.details = response.data;
				$('#showDetailsModal').modal('show', 'keyboard', 'focus');
			})
			.catch(function (error) {
				console.error('Error Not found :', error);
			});
	}

//Update Student
	$scope.doUpdate = function (studentID) {
		const studentToUpdate = $scope.students.find(student => student.id === studentID);
		if (studentToUpdate) {
			$scope.student = {
				id: studentToUpdate.id,
				fName: studentToUpdate.fName,
				lName: studentToUpdate.lName,
				email: studentToUpdate.email,
				semester: studentToUpdate.semester
			};

			$('#updateStudentModal').modal('show', 'keyboard', 'focus');
		} else {
			console.error('Student not found:', studentID);
		}
	};

	$scope.update = function () {
		$http.put('/api/add', $scope.student)
			.then(function (response) {
				var update = "studentUpdate"
				updateMessage(update);
			})
			.catch(function (error) {
				console.error('Error updating student:', error);
			});
	};

	$scope.doUpdateBook = function (bookid) {
		const bookToUpdate = $scope.books.find(book => book.bcode === bookid);
		if (bookToUpdate) {
			$scope.book = {
				bcode: bookToUpdate.bcode,
				bname: bookToUpdate.bname,
				bauthor: bookToUpdate.bauthor,
				year: bookToUpdate.year,
				status: bookToUpdate.status,
				studentDetails: bookToUpdate.studentDetails
			};

			$('#updateBookModal').modal('show', 'keyboard', 'focus');
		} else {
			console.error('Student not found:', studentID);
		}
	};

	$scope.updateBook = function () {
		$http.put('/api/addBook', $scope.book)
			.then(function () {
				$scope.student = null;
				var update = "bookUpdate"
				updateMessage(update);
			})
			.catch(function (error) {
				var from = "bookUpdate"
				errorMessage(from);
			});
	}

	function updateMessage(from) {
		$scope.successMessage = 'Updated successful.';
		$scope.successMessage1 = 'Student data added successfully.';
		$scope.book = null;
		$scope.student = null;
		$('#updateStudentModal').modal('hide');
		$('#updateBookModal').modal('hide');
		if (from === "studentAdd"){
			$('#addStudentModal').modal('hide');
			$('#addSuccessModal').modal('show');
			$timeout(function () {
					$('#addSuccessModal').modal('hide')
					console.log("damnnnnn")
					fetchStudents();
			}, 1000);
		}else{
			$('#SuccessModal').modal('show');
			$scope.book = null;
			$timeout(function () {
				$('#SuccessModal').modal('hide');
				if (from === "bookUpdate"){
					console.log("damnnnnn")
					$scope.triggerBook();
				}else if(from === "studentUpdate"){
					fetchStudents();
				}
			}, 1000);
		}
	};

	function deleteMessage(from){
		$scope.successMessage = 'Data deleted sucessfully.';
		$('#SuccessModal').modal('show');
		$scope.book = null;
		$scope.student = null;
		$timeout(function () {
			$('#SuccessModal').modal('hide');
			if (from){
				fetchStudents();
			}else{
				$scope.triggerBook();
			}
		}, 1000);
	}

	function errorMessage(msg){
		if(msg === "bookUpdate"){
			$('#updateBookModal').modal('hide');
			$('#errorModal').modal('show');
			$scope.errorMessage = 'Student ID not Found';
		}else if (msg ==="addStudent"){
			$('#addStudentModal').modal('hide');
			$('#errorModal').modal('show');
			$scope.errorMessage = 'Email Id already Registered';
		}

	}
	$scope.openAddStudentModal = function () {
		console.log("I was Here!!")
		$('#addStudentModal').modal('show', 'keyboard', 'focus');
	};

//Add Student
	$scope.addStudent = function () {
		$http.post('/api/add', $scope.student)
			.then(function (response) {
				var update = "studentAdd"
				updateMessage(update);
			})
			.catch(function (error) {
				var from = "addStudent"
				errorMessage(from)
				console.error('Error updating student:', error);
			});
	}
}	);